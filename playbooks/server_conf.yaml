# playbooks/server_conf_docker_exec.yaml
- name: Configurar los servidores
  hosts: servers
  gather_facts: no
  connection: local
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:

    - name: Eliminamos la interfaz de gestion de ContainerLabs
      shell: |
        docker exec {{ ansible_docker_container }} vtysh \
          -c "configure terminal" \
          -c "interface eth0" \
          -c "shutdown" \
          -c "exit" \
          -c "exit"

    - name: Configurar IP del servidor con docker exec
      shell: |
        docker exec {{ ansible_docker_container }} vtysh \
          -c "configure terminal" \
          -c "interface eth1" \
          -c "ip address {{ server_net_ip }}/24" \
          -c "exit" \
          -c "ip route 0.0.0.0/0 {{ gateway }}" \
          -c "exit"
      when: server_net_ip is defined

    - name: Configurar BGP del servidor con docker exec
      shell: |
        docker exec {{ ansible_docker_container }} vtysh \
          -c "configure terminal" \
          -c "router bgp 65100" \
          -c "neighbor dc peer-group" \
          -c "neighbor dc remote-as 65100" \
          -c "neighbor dc update-source eth1" \
          -c "address-family l2vpn evpn" \
          -c "neighbor dc activate" \
          -c "advertise-all-vni" \
          -c "exit-address-family" \
          -c "exit"

    - name: Configurar vecinos EVPN en el servidor
      shell: |
        docker exec {{ ansible_docker_container }} vtysh \
          -c "configure terminal" \
          -c "router bgp 65100" \
          -c "neighbor 1.0.0.1 peer-group dc" \
          -c "neighbor 1.0.0.2 peer-group dc" \
          -c "exit" \
          -c "exit"

    - name: Guardar configuraci√≥n del servidor con docker exec
      shell: |
        docker exec {{ ansible_docker_container }} vtysh -c "copy running-config startup-config"